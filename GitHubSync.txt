/**
 * ========================================
 * GITHUB SYNC MODULE - STANDALONE
 * ========================================
 * File riÃªng: GitHubSync.gs
 * 
 * Chá»©c nÄƒng:
 * - Push HTML/JS/CSS files lÃªn GitHub tá»± Ä‘á»™ng
 * - Test connection
 * - View commit history
 * - code.gs Ä‘Æ°á»£c cáº­p nháº­t thá»§ cÃ´ng
 * 
 * CÃ¡ch sá»­ dá»¥ng:
 * 1. Táº¡o file má»›i: GitHubSync.gs
 * 2. Copy toÃ n bá»™ code nÃ y vÃ o
 * 3. Cháº¡y GitHubSync.push() Ä‘á»ƒ sync
 * ========================================
 */

/**
 * âš™ï¸ Cáº¤U HÃŒNH GITHUB
 * Äiá»n thÃ´ng tin repo cá»§a báº¡n vÃ o Ä‘Ã¢y
 */
const GITHUB_CONFIG = {
  OWNER: "nhanca666",
  TOKEN: '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', // âš ï¸ NÃŠN LÆ¯U VÃ€O Script Properties
  REPO: 'gas-inventory-system',
  BRANCH: 'main',
  
  // Danh sÃ¡ch file sáº½ Ä‘Æ°á»£c push tá»± Ä‘á»™ng
  FILES_TO_SYNC: [
    'Index.html',
    'Drawer.html',
    'Footer.html',
    'Javascript.html',
    'main.html',
    'section.html',
    'Stylesheet.html'
  ]
};

/**
 * ========================================
 * NAMESPACE: GitHubSync
 * Táº¥t cáº£ functions Ä‘á»u náº±m trong object nÃ y
 * ========================================
 */
const GitHubSync = {
  
  /**
   * HÃ€M CHÃNH: PUSH HTML FILES LÃŠN GITHUB
   * Gá»i: GitHubSync.push()
   */
  push: function() {
    try {
      const ui = SpreadsheetApp.getUi();
      
      // XÃ¡c nháº­n
      const confirm = ui.alert(
        'ğŸš€ Push to GitHub', 
        `Sáº½ push ${GITHUB_CONFIG.FILES_TO_SYNC.length} files HTML lÃªn GitHub.\n\n` +
        'ğŸ“ code.gs KHÃ”NG Ä‘Æ°á»£c push tá»± Ä‘á»™ng.\n\n' +
        'Tiáº¿p tá»¥c?', 
        ui.ButtonSet.YES_NO
      );
      
      if (confirm !== ui.Button.YES) {
        ui.alert('âŒ ÄÃ£ há»§y');
        return { success: false, message: 'Cancelled by user' };
      }
      
      SpreadsheetApp.getActiveSpreadsheet().toast(
        'ğŸ“„ Äang Ä‘á»c files...', 
        'GitHub Sync', 
        3
      );
      
      let successCount = 0;
      let errorFiles = [];
      const timestamp = new Date().toISOString();
      
      // Push tá»«ng file
      GITHUB_CONFIG.FILES_TO_SYNC.forEach(fileName => {
        try {
          SpreadsheetApp.getActiveSpreadsheet().toast(
            `ğŸ“¤ ${fileName}...`, 
            'Pushing', 
            2
          );
          
          // Äá»c ná»™i dung
          const content = HtmlService.createHtmlOutputFromFile(
            fileName.replace('.html', '')
          ).getContent();
          
          // Push
          const result = GitHubSync._pushSingleFile(fileName, content, timestamp);
          
          if (result.success) {
            successCount++;
          } else {
            errorFiles.push(`${fileName}: ${result.message}`);
          }
          
          // Delay trÃ¡nh rate limit
          Utilities.sleep(500);
          
        } catch (e) {
          errorFiles.push(`${fileName}: ${e.toString()}`);
        }
      });
      
      // ThÃ´ng bÃ¡o káº¿t quáº£
      const totalFiles = GITHUB_CONFIG.FILES_TO_SYNC.length;
      
      if (successCount === totalFiles) {
        ui.alert(
          'âœ… Push thÃ nh cÃ´ng!', 
          `ÄÃ£ push ${successCount}/${totalFiles} files.\n\n` +
          `ğŸ“… ${timestamp}\n` +
          `ğŸ”— github.com/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}\n\n` +
          `ğŸ“ Nhá»› cáº­p nháº­t code.gs thá»§ cÃ´ng khi cÃ³ thay Ä‘á»•i!`, 
          ui.ButtonSet.OK
        );
      } else {
        ui.alert(
          'âš ï¸ Push má»™t pháº§n', 
          `ThÃ nh cÃ´ng: ${successCount}/${totalFiles}\n\n` +
          `Lá»—i:\n${errorFiles.join('\n')}`, 
          ui.ButtonSet.OK
        );
      }
      
      return { 
        success: true, 
        pushed: successCount, 
        failed: errorFiles.length,
        errors: errorFiles 
      };
      
    } catch (e) {
      SpreadsheetApp.getUi().alert('âŒ Lá»—i: ' + e.toString());
      return { success: false, message: e.toString() };
    }
  },
  
  /**
   * HÃ€M PRIVATE: PUSH 1 FILE
   * Gá»i ná»™i bá»™ bá»Ÿi GitHubSync.push()
   */
  _pushSingleFile: function(fileName, content, timestamp) {
    try {
      const apiBase = `https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}`;
      
      // 1. Láº¥y SHA file hiá»‡n táº¡i (náº¿u cÃ³)
      let currentSHA = null;
      try {
        const getUrl = `${apiBase}/contents/${fileName}?ref=${GITHUB_CONFIG.BRANCH}`;
        const getResponse = UrlFetchApp.fetch(getUrl, {
          headers: {
            'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          },
          muteHttpExceptions: true
        });
        
        if (getResponse.getResponseCode() === 200) {
          currentSHA = JSON.parse(getResponse.getContentText()).sha;
        }
      } catch (e) {
        // File chÆ°a tá»“n táº¡i
      }
      
      // 2. Táº¡o payload
      const payload = {
        message: `[AUTO] Update ${fileName} - ${timestamp}`,
        content: Utilities.base64Encode(content),
        branch: GITHUB_CONFIG.BRANCH
      };
      
      if (currentSHA) {
        payload.sha = currentSHA;
      }
      
      // 3. Push
      const putUrl = `${apiBase}/contents/${fileName}`;
      const putResponse = UrlFetchApp.fetch(putUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        payload: JSON.stringify(payload),
        muteHttpExceptions: true
      });
      
      const code = putResponse.getResponseCode();
      
      if (code === 200 || code === 201) {
        return { success: true };
      } else {
        const error = JSON.parse(putResponse.getContentText());
        return { success: false, message: error.message || 'Unknown error' };
      }
      
    } catch (e) {
      return { success: false, message: e.toString() };
    }
  },
  
  /**
   * TEST CONNECTION
   * Gá»i: GitHubSync.test()
   */
  test: function() {
    try {
      const url = `https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}`;
      const response = UrlFetchApp.fetch(url, {
        headers: {
          'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      
      const repo = JSON.parse(response.getContentText());
      
      SpreadsheetApp.getUi().alert(
        'âœ… Káº¿t ná»‘i thÃ nh cÃ´ng!',
        `Repo: ${repo.full_name}\n` +
        `Branch: ${GITHUB_CONFIG.BRANCH}\n` +
        `Private: ${repo.private}\n` +
        `Files to sync: ${GITHUB_CONFIG.FILES_TO_SYNC.length}\n` +
        `Last push: ${repo.pushed_at}`,
        SpreadsheetApp.getUi().ButtonSet.OK
      );
      
      return { success: true };
      
    } catch (e) {
      SpreadsheetApp.getUi().alert(
        'âŒ Lá»—i káº¿t ná»‘i',
        `${e.toString()}\n\n` +
        'ğŸ’¡ Kiá»ƒm tra:\n' +
        '1. Token cÃ²n hiá»‡u lá»±c?\n' +
        '2. Token cÃ³ quyá»n "repo"?\n' +
        '3. Repo name Ä‘Ãºng?',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
      
      return { success: false, message: e.toString() };
    }
  },
  
  /**
   * XEM COMMIT Má»šI NHáº¤T
   * Gá»i: GitHubSync.viewLatestCommit()
   */
  viewLatestCommit: function() {
    try {
      const url = `https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}/commits?per_page=1`;
      const response = UrlFetchApp.fetch(url, {
        headers: {
          'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      
      const commits = JSON.parse(response.getContentText());
      const latest = commits[0];
      
      SpreadsheetApp.getUi().alert(
        'ğŸ“ Latest Commit',
        `SHA: ${latest.sha.substring(0, 7)}\n` +
        `Message: ${latest.commit.message}\n` +
        `Author: ${latest.commit.author.name}\n` +
        `Date: ${latest.commit.author.date}`,
        SpreadsheetApp.getUi().ButtonSet.OK
      );
      
      return {
        sha: latest.sha,
        message: latest.commit.message,
        author: latest.commit.author.name,
        date: latest.commit.author.date
      };
      
    } catch (e) {
      SpreadsheetApp.getUi().alert('âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c commit: ' + e.toString());
      return null;
    }
  },
  
  /**
   * Láº¤Y DANH SÃCH FILES Sáº¼ PUSH
   * Gá»i: GitHubSync.listFiles()
   */
  listFiles: function() {
    const files = GITHUB_CONFIG.FILES_TO_SYNC.map((name, index) => 
      `${index + 1}. ${name}`
    ).join('\n');
    
    SpreadsheetApp.getUi().alert(
      'ğŸ“ Files sáº½ Ä‘Æ°á»£c push',
      `Tá»•ng: ${GITHUB_CONFIG.FILES_TO_SYNC.length} files\n\n${files}\n\n` +
      'ğŸ“ code.gs KHÃ”NG Ä‘Æ°á»£c push tá»± Ä‘á»™ng.',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  },
  
  /**
   * Cáº¤U HÃŒNH TOKEN AN TOÃ€N
   * LÆ°u token vÃ o Script Properties thay vÃ¬ hardcode
   * Gá»i: GitHubSync.setupToken('your_token_here')
   */
  setupToken: function(token) {
    if (!token) {
      SpreadsheetApp.getUi().alert('âŒ Token khÃ´ng Ä‘Æ°á»£c rá»—ng!');
      return;
    }
    
    PropertiesService.getScriptProperties().setProperty('GITHUB_TOKEN', token);
    
    SpreadsheetApp.getUi().alert(
      'âœ… ÄÃ£ lÆ°u token!',
      'Token Ä‘Æ°á»£c lÆ°u an toÃ n vÃ o Script Properties.\n\n' +
      'BÃ¢y giá» báº¡n cÃ³ thá»ƒ xÃ³a token trong code.',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  },
  
  /**
   * Láº¤Y TOKEN Tá»ª PROPERTIES (AN TOÃ€N HÆ N)
   */
  _getToken: function() {
    const stored = PropertiesService.getScriptProperties().getProperty('GITHUB_TOKEN');
    return stored || GITHUB_CONFIG.TOKEN;
  }
};

/**
 * ========================================
 * MENU INTEGRATION
 * ThÃªm vÃ o menu chÃ­nh cá»§a á»©ng dá»¥ng
 * ========================================
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  
  ui.createMenu('ğŸš€ GITHUB SYNC')
    .addItem('ğŸ“¤ Push HTML Files', 'menuPushToGitHub')
    .addItem('ğŸ§ª Test Connection', 'menuTestConnection')
    .addItem('ğŸ“Š View Latest Commit', 'menuViewCommit')
    .addItem('ğŸ“ List Files', 'menuListFiles')
    .addSeparator()
    .addItem('ğŸ” Setup Token', 'menuSetupToken')
    .addToUi();
}

/**
 * ========================================
 * MENU HANDLERS
 * CÃ¡c hÃ m nÃ y gá»i GitHubSync methods
 * ========================================
 */
function menuPushToGitHub() {
  GitHubSync.push();
}

function menuTestConnection() {
  GitHubSync.test();
}

function menuViewCommit() {
  GitHubSync.viewLatestCommit();
}

function menuListFiles() {
  GitHubSync.listFiles();
}

function menuSetupToken() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'ğŸ” Setup GitHub Token',
    'Paste your GitHub Personal Access Token:\n\n' +
    'ğŸ’¡ Token cáº§n quyá»n "repo"',
    ui.ButtonSet.OK_CANCEL
  );
  
  if (response.getSelectedButton() === ui.Button.OK) {
    GitHubSync.setupToken(response.getResponseText());
  }
}