<v-dialog v-model="dialogEdit" max-width="600px"><v-card><v-card-title class="teal darken-3 white--text title">MAPPING & CORRECTION</v-card-title><v-card-text class="pt-6"><v-row dense><v-col cols="6"><v-text-field v-model="editingItem.term" label="T? kh?a (Keyword)" outlined dense readonly background-color="grey lighten-4"></v-text-field></v-col><v-col cols="6"><v-select v-model="editingItem.context" :items="storeCodes" label="Ng? c?nh (Store)" outlined dense></v-select></v-col><v-col cols="12" v-if="!editingItem.isSpoilage"><v-text-field v-model="editingItem.sender" label="Nh?n vi?n (Sender)" outlined dense placeholder="S?a l?i t?n nh?n vi?n..."></v-text-field></v-col></v-row><v-autocomplete v-model="editingItem.code" :items="editorMasterData" item-text="editorLabel" item-value="code" label="Ch?n M? ??ch (SAP / N?i b?)" outlined :filter="customFilterAutocomplete" return-object @change="onMasterItemSelect"><template v-slot:selection="{ item }"><span class="font-weight-bold blue--text">{{ item.editorCode }}</span> - {{ item.name }}</template><template v-slot:item="{ item }"><v-list-item-content><v-list-item-title><span class="font-weight-bold blue--text">{{ item.editorCode }}</span> - {{ item.name }}</v-list-item-title></v-list-item-content></template></v-autocomplete><div class="d-flex justify-end mt-2" v-if="editingItem.code"><v-btn color="red lighten-1" text @click="requestDeleteMapping(editingItem)">X?a Mapping</v-btn></div></v-card-text><v-card-actions class="grey lighten-4 pa-3"><v-btn color="teal darken-2" dark block depressed @click="saveEdit">L?u & H?c</v-btn></v-card-actions></v-card></v-dialog>

<v-dialog v-model="dialogMaster.show" max-width="950px"><v-card><v-card-title class="blue-grey darken-3 white--text title">{{ dialogMaster.action === 'ADD' ? 'TH?M M?I' : 'S?A' }}</v-card-title><div class="pa-2 mt-2"><style>.big-input input,.big-input .v-select__selection{font-size:19px!important;font-weight:500;color:#000!important}.big-input label{font-size:15px!important}.big-input .v-icon{color:#546E7A!important}.cost-text input{color:#263238!important;font-weight:900!important}</style><v-row dense><v-col cols="2" class="py-1"><v-select v-model="dialogMaster.item.type" :items="['NVL', 'SEMI', 'PROD']" label="1. Lo?i" outlined dense :disabled="dialogMaster.action==='EDIT'" @change="suggestNextCode" height="40" class="big-input"></v-select></v-col><v-col cols="2" class="py-1" v-if="dialogMaster.item.type === 'SEMI'"><v-select v-model="dialogMaster.item.dept" :items="['Kitchen', 'Pizza', 'Service']" label="B? Ph?n" outlined dense height="40" @change="suggestNextCode" class="big-input"></v-select></v-col><v-col :cols="dialogMaster.item.type === 'SEMI' ? 3 : 5" class="py-1"><v-text-field v-model="dialogMaster.item.code" label="2. M? H?ng" outlined dense height="40" append-icon="mdi-refresh" @click:append="suggestNextCode" class="big-input"></v-text-field></v-col><v-col cols="5" class="py-1"><v-text-field v-model.lazy="dialogMaster.item.name" label="3. T?n H?ng (*)" outlined dense height="40" class="big-input"></v-text-field></v-col><template v-if="dialogMaster.item.type === 'NVL'"><v-col cols="12"><v-divider class="mb-3 mt-1"></v-divider></v-col><v-col cols="3" class="py-1"><v-text-field v-model="dialogMaster.item.unit" label="?VT G?c" outlined dense placeholder="Gr" height="40" class="big-input"></v-text-field></v-col><v-col cols="3" class="py-1"><v-text-field v-model="dialogMaster.item.stdUnit" label="?VT Mua" outlined dense placeholder="Kg" height="40" class="big-input"></v-text-field></v-col><v-col cols="3" class="py-1"><v-text-field v-model="dialogMaster.item.rate" label="H? s?" type="number" outlined dense @input="calculateCostFromBuying" height="40" class="big-input"></v-text-field></v-col><v-col cols="3" class="py-1"><v-text-field v-model="dialogMaster.item.buyingPrice" label="Gi? Mua" type="number" outlined dense suffix="?" @input="calculateCostFromBuying" height="40" class="big-input"></v-text-field></v-col><v-col cols="4" class="py-1"><v-text-field v-model="dialogMaster.item.cost" label="Gi? V?n (Base)" type="number" outlined dense suffix="?" readonly filled background-color="#ECEFF1" height="40" class="big-input cost-text"></v-text-field></v-col><v-col cols="4" class="py-1"><v-text-field v-model="dialogMaster.item.supplier" label="NCC" outlined dense prepend-inner-icon="mdi-truck" height="40" class="big-input"></v-text-field></v-col><v-col cols="2" class="py-1"><v-text-field v-model="dialogMaster.item.leadtime" label="Leadtime" outlined dense height="40" class="big-input"></v-text-field></v-col><v-col cols="2" class="py-1"><v-text-field v-model="dialogMaster.item.group" label="Group" outlined dense height="40" class="big-input"></v-text-field></v-col></template><template v-if="dialogMaster.item.type === 'SEMI'"><v-col cols="12" class="py-1"><div class="d-flex align-center justify-space-between px-3 py-2 mb-2 rounded elevation-1 white"><div class="d-flex align-center"><span class="subtitle-1 font-weight-bold grey--text text--darken-3 mr-4">TH?NH PH?N (BOM)</span><span class="mr-1 caption grey--text">BATCH:</span><span class="title font-weight-bold mr-4" style="color:#000">{{ formatNumber(dialogMaster.item.ingredients ? dialogMaster.item.ingredients.reduce((sum, x) => sum + calculateLineTotal(x), 0) : 0) }}</span><span class="mr-1 caption grey--text">UNIT:</span><span class="title font-weight-bold blue-grey--text text--darken-4">{{ formatNumber((dialogMaster.item.ingredients ? dialogMaster.item.ingredients.reduce((sum, x) => sum + calculateLineTotal(x), 0) : 0) / (Number(dialogMaster.item.yield) || 1)) }}</span></div><div class="d-flex align-center"><v-text-field v-model="dialogMaster.item.yield" type="number" label="Yield" outlined dense hide-details class="big-input mr-2" style="max-width: 100px;" height="40"></v-text-field><v-btn small color="teal darken-1" dark depressed @click="addMasterIngRow" height="40"><v-icon left>mdi-plus</v-icon>NVL</v-btn></div></div><v-simple-table dense fixed-header height="350px" style="border: 1px solid #B0BEC5;"><template v-slot:default><thead><tr><th class="text-left pl-2 py-1 subtitle-2 black--text">T?n NVL</th><th width="90px" class="text-right subtitle-2 black--text">SL</th><th width="60px" class="text-center subtitle-2 black--text">?VT</th><th width="100px" class="text-right subtitle-2 black--text">Gi? V?n</th><th width="120px" class="text-right subtitle-2 black--text">Ti?n</th><th width="40px"></th></tr></thead><tbody><tr v-for="(ing, i) in dialogMaster.item.ingredients" :key="i"><td class="pl-2 py-1"><v-autocomplete v-model="ing.code" :items="masterData" item-text="fullName" item-value="code" dense hide-details outlined class="caption" placeholder="M?.." :filter="customFilterAutocomplete" @change="val =&gt; fillBomInfo(ing, val)"><template v-slot:item="{ item }"><div class="py-2"><span class="blue--text font-weight-bold body-1">{{ item.code }}</span> - <span class="body-1 black--text">{{ item.name }}</span></div></template></v-autocomplete></td><td class="pa-1"><v-text-field v-model="ing.qty" type="number" dense hide-details outlined class="centered-input font-weight-bold big-input no-spin"></v-text-field></td><td class="text-center body-2 font-weight-bold">{{ ing.unit }}</td><td class="text-right body-2 grey--text text--darken-2">{{ formatNumber(getUnitPrice(ing.code)) }}</td><td class="text-right body-2 font-weight-bold black--text">{{ formatNumber(calculateLineTotal(ing)) }}</td><td class="text-center"><v-icon color="red lighten-1" @click="dialogMaster.item.ingredients.splice(i, 1)">mdi-close-circle</v-icon></td></tr></tbody></template></v-simple-table></v-col></template><template v-if="dialogMaster.item.type === 'PROD'"><v-col cols="12"><v-divider class="my-2"></v-divider></v-col><v-col cols="3" class="py-1"><v-text-field v-model="dialogMaster.item.sapCode" label="M? SAP" outlined dense class="big-input" height="40"></v-text-field></v-col><v-col cols="3" class="py-1"><v-text-field v-model="dialogMaster.item.category" label="Category" outlined dense height="40" class="big-input"></v-text-field></v-col><v-col cols="2" class="py-1"><v-text-field v-model="dialogMaster.item.unit" label="?VT" outlined dense height="40" class="big-input"></v-text-field></v-col><v-col cols="2" class="py-1"><v-text-field v-model="dialogMaster.item.cost" label="Gi? V?n" type="number" outlined dense suffix="?" class="big-input cost-text" height="40"></v-text-field></v-col><v-col cols="2" class="py-1"><v-select v-model="dialogMaster.item.team" :items="['Kitchen', 'Pizza', 'Service', 'Bar']" label="Team" outlined dense height="40" class="big-input"></v-select></v-col><v-col cols="12" class="py-1"><div class="d-flex align-center justify-space-between px-3 py-2 mb-2 rounded elevation-1 blue lighten-5"><div class="d-flex align-center"><span class="subtitle-1 font-weight-bold blue--text text--darken-4 mr-4">BOM PRODUCT</span><span class="mr-1 caption grey--text">TOTAL:</span><span class="title font-weight-bold blue-grey--text text--darken-4">{{ formatNumber(dialogMaster.item.ingredients ? dialogMaster.item.ingredients.reduce((sum, x) => sum + calculateLineTotal(x), 0) : 0) }}</span></div><v-btn small color="blue darken-3" dark depressed @click="addMasterIngRow" height="40"><v-icon left>mdi-plus</v-icon>NVL</v-btn></div><v-simple-table dense fixed-header height="350px" style="border: 1px solid #90CAF9;"><template v-slot:default><thead><tr class="blue lighten-4"><th class="text-left pl-2 py-1 subtitle-2 black--text">T?n NVL / Semi</th><th width="90px" class="text-right subtitle-2 black--text">SL</th><th width="60px" class="text-center subtitle-2 black--text">?VT</th><th width="100px" class="text-right subtitle-2 black--text">Gi? V?n</th><th width="120px" class="text-right subtitle-2 black--text">Ti?n</th><th width="40px"></th></tr></thead><tbody><tr v-for="(ing, i) in dialogMaster.item.ingredients" :key="i"><td class="pl-2 py-1"><v-autocomplete v-model="ing.code" :items="masterData" item-text="fullName" item-value="code" dense hide-details outlined class="caption" placeholder="M?.." :filter="customFilterAutocomplete" @change="val =&gt; fillBomInfo(ing, val)"><template v-slot:item="{ item }"><div class="py-2"><span class="blue--text font-weight-bold body-1">{{ item.code }}</span> - <span class="body-1 black--text">{{ item.name }}</span></div></template></v-autocomplete></td><td class="pa-1"><v-text-field v-model="ing.qty" type="number" dense hide-details outlined class="centered-input font-weight-bold big-input no-spin"></v-text-field></td><td class="text-center body-2 font-weight-bold">{{ ing.unit }}</td><td class="text-right body-2 grey--text text--darken-2">{{ formatNumber(getUnitPrice(ing.code)) }}</td><td class="text-right body-2 font-weight-bold black--text">{{ formatNumber(calculateLineTotal(ing)) }}</td><td class="text-center"><v-icon color="red lighten-1" @click="dialogMaster.item.ingredients.splice(i, 1)">mdi-close-circle</v-icon></td></tr></tbody></template></v-simple-table></v-col></template></v-row></div><v-card-actions class="grey lighten-4 pa-4 d-flex align-center"><v-select v-model="dialogMaster.item.status" :items="['Active', 'Inactive']" label="Tr?ng th?i" outlined dense hide-details background-color="white" style="max-width: 200px;" prepend-inner-icon="mdi-toggle-switch" class="font-weight-bold"></v-select><v-spacer></v-spacer><v-btn text @click="dialogMaster.show=false" class="mr-2" color="grey darken-2">H?y</v-btn><v-btn color="blue darken-3" dark depressed width="120" @click="saveMasterData" class="font-weight-bold">L?u</v-btn></v-card-actions></v-card></v-dialog>

<v-dialog v-model="dialogTrace.show" max-width="98vw" scrollable transition="dialog-bottom-transition"><v-card tile><v-card-title class="blue-grey darken-4 white--text title d-flex justify-space-between shadow-header" style="border-bottom:3px solid #FFD600;height:65px"><div class="d-flex align-center"><v-icon left color="yellow accent-4">mdi-radar</v-icon><span class="mr-4">SHADOW TRACE</span><v-menu offset-y :close-on-content-click="false"><template v-slot:activator="{on,attrs}"><v-btn small color="purple accent-3" dark depressed class="font-weight-black elevation-2" v-bind="attrs" v-on="on" @click="loadSalesPeriods"><v-icon left small>mdi-cash-register</v-icon>{{selectedTracePeriod||'R?P DOANH THU'}}</v-btn></template><v-list dense><v-subheader class="font-weight-bold">CH?N K? B?O C?O</v-subheader><v-list-item v-for="p in tracePeriods" :key="p" @click="applyTraceSales(p)"><v-list-item-title class="font-weight-bold">{{p}}</v-list-item-title></v-list-item></v-list></v-menu></div><v-btn icon small dark @click="dialogTrace.show=false"><v-icon>mdi-close</v-icon></v-btn></v-card-title><div class="blue-grey darken-4 px-4 py-2 d-flex align-center" style="border-bottom:1px solid #455A64"><span class="caption cyan--text text--accent-2 mr-2 font-weight-black" style="letter-spacing:1px">??I T??NG ?ANG SOI:</span><v-chip color="cyan darken-4" dark label small class="font-weight-black elevation-2" style="border:1px solid #00E5FF; color:#00E5FF!important">{{ dialogTrace.target }}</v-chip></div><v-card-text class="pa-0"><v-data-table :headers="headersTrace" :items="dialogTrace.items" fixed-header height="78vh" :items-per-page="-1" hide-default-footer class="clean-table elevation-0 theme--dark">
<template v-slot:header.code><div class="trace-header-cell yellow--text text--accent-3 text-left">M? SKU<span class="trace-header-sub">(PRODUCT CODE)</span></div></template>
<template v-slot:header.name><div class="trace-header-cell yellow--text text--accent-3 text-left">T?N TH??NG M?I<span class="trace-header-sub">(COMMERCIAL NAME)</span></div></template>
<template v-slot:header.qty><div class="trace-header-cell yellow--text text--accent-3 text-right">??NH M?C<span class="trace-header-sub">(UNIT STD)</span></div></template>
<template v-slot:header.totalUsage><div class="trace-header-cell yellow--text text--accent-3 text-right">NHU C?U T?NG<span class="trace-header-sub">(THEORETICAL)</span></div></template>
<template v-slot:header.unit><div class="trace-header-cell yellow--text text--accent-3 text-center">??N V?<span class="trace-header-sub">(UOM)</span></div></template>
<template v-slot:header.path><div class="trace-header-cell yellow--text text--accent-3 text-left">C?U TR?C PH?N T?CH<span class="trace-header-sub">(TRACEABILITY BOM)</span></div></template>
<template v-slot:header.path><div class="text-left yellow--text text--accent-3 font-weight-black" style="line-height:1.2">C?U TR?C PH?N T?CH<br><span class="blue-grey--text text--lighten-2" style="font-size:9px!important">(TRACEABILITY BOM)</span></div></template><template v-slot:header.unit><div class="d-flex align-center justify-center" style="height:48px;width:100%"><div class="text-center yellow--text text--accent-3 font-weight-black" style="line-height:1.1">??N V?<br><span class="blue-grey--text text--lighten-2" style="font-size:9px!important">(UOM)</span></div></div></template><template v-slot:header.path><div class="d-flex align-center" style="height:48px"><div class="text-left yellow--text text--accent-3 font-weight-black" style="line-height:1.1">C?U TR?C PH?N T?CH<br><span class="blue-grey--text text--lighten-2" style="font-size:9px!important">(TRACEABILITY BOM)</span></div></div></template><template v-slot:item.code="{item}"><span class="font-weight-bold blue-grey--text text--lighten-3 code-text" style="font-family:'Consolas',monospace">{{item.code}}</span></template><template v-slot:item.name="{item}"><div class="font-weight-bold white--text body-2">{{item.name}}</div></template><template v-slot:item.qty="{item}"><div class="font-weight-bold white--text title">{{formatNumber(parseUSNum(item.qty))}} <span class="caption grey--text ml-1">{{item.unit}}</span></div></template><template v-slot:item.totalUsage="{item}">
  <div class="white--text title font-weight-black text-right">
    {{ formatTraceUsage(item.totalUsage, item.unit) }}
  </div>
</template><template v-slot:item.path="{item}"><div class="trace-tree-view" v-html="renderTracePath(item)"></div></template></v-data-table></v-card-text></v-card></v-dialog>

<v-dialog v-model="dialogBOM" max-width="950px" scrollable><v-card><v-card-title class="blue-grey darken-4 white--text title font-weight-bold py-2"><v-icon left dark>mdi-sitemap</v-icon> C?U H?NH BOM (??NH M?C)</v-card-title><v-card-text class="pa-0"><div class="grey lighten-4 pa-4 mb-0" style="border-bottom: 1px solid #B0BEC5;"><v-row dense align="center"><v-col cols="4"><div class="caption grey--text text--darken-2 font-weight-bold mb-1">1. M? & T?N H?NG</div><div class="blue-grey--text text--darken-4 font-weight-black title text-truncate" :title="currentBOMItem.name">{{ currentBOMItem.code }} - {{ currentBOMItem.name }}</div></v-col><v-col cols="2" class="text-center" style="border-left: 1px solid #CFD8DC;"><div class="caption deep-orange--text text--darken-3 font-weight-bold mb-1">2. GI? V?N (UNIT)</div><div class="deep-orange--text text--darken-4 font-weight-black headline">{{ formatNumber(bomStats.unitCost) }}</div></v-col><v-col cols="2" class="text-center" style="border-left: 1px solid #CFD8DC;"><div class="caption teal--text text--darken-3 font-weight-bold mb-1">3. ??NH L??NG (BATCH)</div><v-text-field v-model="bomHeader.yield" type="number" outlined dense hide-details class="centered-input font-weight-black white elevation-1" style="font-size: 18px;" color="teal"></v-text-field></v-col><v-col cols="2" class="text-center" style="border-left: 1px solid #CFD8DC;"><div class="caption blue-grey--text text--darken-3 font-weight-bold mb-1">4. T?NG GI? BATCH</div><div class="blue-grey--text text--darken-3 font-weight-black headline">{{ formatNumber(bomStats.totalCost) }}</div></v-col><v-col cols="2" class="text-center" style="border-left: 1px solid #CFD8DC;"><div class="caption brown--text text--darken-3 font-weight-bold mb-1">5. ?VT (UNIT)</div><v-text-field v-model="bomHeader.unit" outlined dense hide-details class="centered-input font-weight-bold white elevation-1" color="brown"></v-text-field></v-col></v-row><div class="d-flex justify-space-between align-center mt-3 pt-2" style="border-top: 1px dashed #B0BEC5;"><v-select v-model="currentBOMItem.sourceSheet" :items="Object.values(sheetConfig)" label="Ngu?n l?u (Source)" outlined dense hide-details style="max-width: 250px;" class="font-weight-bold" color="blue-grey"></v-select><v-btn color="teal darken-3" dark depressed class="font-weight-bold" @click="addIngRow"><v-icon left>mdi-plus-circle</v-icon> Th?m Th?nh Ph?n (NVL)</v-btn></div></div><v-simple-table fixed-header height="55vh" class="bom-table" dense style="border-top: 1px solid #CFD8DC;"><template v-slot:default><thead class="blue-grey darken-3"><tr><th class="text-left white--text subtitle-2 font-weight-bold pl-4" style="border-right: 1px solid #546E7A;">TH?NH PH?N (M? & T?N)</th><th class="text-center white--text subtitle-2 font-weight-bold" width="80px" style="border-right: 1px solid #546E7A;">LO?I</th><th class="text-right white--text subtitle-2 font-weight-bold" width="120px" style="border-right: 1px solid #546E7A;">S? L??NG</th><th class="text-center white--text subtitle-2 font-weight-bold" width="80px" style="border-right: 1px solid #546E7A;">?VT</th><th class="text-right white--text subtitle-2 font-weight-bold" width="160px" style="border-right: 1px solid #546E7A;">CHI PH? (COST)</th><th class="text-center white--text subtitle-2 font-weight-bold" width="50px">#</th></tr></thead><tbody><tr v-for="(ing, index) in bomIngredients" :key="index" :style="{backgroundColor: index % 2 === 0 ? '#FFFFFF' : '#FAFAFA'}" style="border-bottom: 1px solid #CFD8DC;"><td class="align-middle py-2 pl-3" style="border-right: 1px solid #ECEFF1;"><v-autocomplete v-model="ing.code" :items="masterData" item-text="fullName" item-value="code" dense hide-details outlined class="caption no-border-input font-weight-bold" :filter="customFilterAutocomplete" @change="val =&gt; fillBomInfo(ing, val)" placeholder="T?m m?..." color="blue-grey"><template v-slot:selection="{ item }"><div class="d-flex flex-column" style="width: 100%;"><div class="blue--text text--darken-3 font-weight-bold" style="font-size: 13px;">{{ item.code }}</div><div class="black--text text-truncate" style="font-size: 13px;">{{ item.name }}</div></div></template><template v-slot:item="{ item }"><div class="py-2"><span class="blue--text text--darken-3 font-weight-bold">{{ item.code }}</span> - <span>{{ item.name }}</span></div></template></v-autocomplete></td><td class="align-middle text-center" style="border-right: 1px solid #ECEFF1;"><v-chip x-small label class="font-weight-bold" :color="getIngType(ing.code)==='SEMI'?'deep-orange lighten-5':(getIngType(ing.code)==='PROD'?'blue lighten-5':'teal lighten-5')" :class="getIngType(ing.code)==='SEMI'?'deep-orange--text text--darken-4':(getIngType(ing.code)==='PROD'?'blue--text text--darken-4':'teal--text text--darken-4')">{{ getIngType(ing.code) }}</v-chip></td><td class="align-middle pa-2" style="border-right: 1px solid #ECEFF1;"><v-text-field v-model="ing.qty" type="number" outlined dense hide-details class="centered-input white elevation-0 font-weight-bold" style="font-size: 15px;" color="blue-grey darken-3"></v-text-field></td><td class="align-middle" style="border-right: 1px solid #ECEFF1;"><div class="font-weight-bold grey--text text--darken-3 text-center" style="font-size: 14px;">{{ ing.unit }}</div></td><td class="text-right align-middle pr-3" style="border-right: 1px solid #ECEFF1;"><div class="font-weight-black deep-orange--text text--darken-4" style="font-size: 16px;">{{ formatNumber(calculateLineTotal(ing)) }}</div><div class="caption grey--text">{{ formatNumber(getUnitPrice(ing.code)) }} / {{ ing.unit }}</div></td><td class="text-center align-middle"><v-btn icon small color="red lighten-1" @click="bomIngredients.splice(index, 1)"><v-icon small>mdi-close</v-icon></v-btn></td></tr></tbody></template></v-simple-table></v-card-text><v-card-actions class="grey lighten-3 pa-3"><v-spacer></v-spacer><v-btn text color="grey darken-2" @click="dialogBOM = false" class="mr-2 font-weight-bold">H?y B?</v-btn><v-btn color="blue-grey darken-4" dark depressed width="150" class="font-weight-bold" @click="saveBOM"><v-icon left>mdi-content-save</v-icon> L?U BOM</v-btn></v-card-actions></v-card></v-dialog>
<v-dialog v-model="dialogEditHistory" max-width="800px" persistent><v-card><v-card-title class="blue-grey darken-3 white--text title font-weight-bold"><v-icon left dark>mdi-file-document-edit</v-icon> S?A PHI?U</v-card-title><v-card-text class="pt-6"><v-form ref="formHistory"><v-row dense><v-col cols="3"><v-text-field v-model="editedHistoryItem.date" label="Ng?y" outlined dense></v-text-field></v-col><v-col cols="3"><v-select v-model="editedHistoryItem.type" :items="['IN', 'OUT']" label="Lo?i" outlined dense></v-select></v-col><v-col cols="3"><v-text-field v-model="editedHistoryItem.sender" label="G?i" outlined dense></v-text-field></v-col><v-col cols="3"><v-text-field v-model="editedHistoryItem.receiver" label="Nh?n" outlined dense></v-text-field></v-col></v-row><v-row dense><v-col cols="4"><v-select v-model="editedHistoryItem.store" :items="storeCodes" label="Store" outlined dense></v-select></v-col><v-col cols="8"><v-autocomplete v-model="editedHistoryItem.code" :items="masterData" item-text="fullName" item-value="code" label="M? H?ng" outlined dense @change="onHistoryCodeChange" return-object><template v-slot:selection="{ item }"><span class="font-weight-bold blue--text">{{ item.code }}</span> - {{ item.name }}</template><template v-slot:item="{ item }"><div><b>{{ item.code }}</b> - {{ item.name }}</div></template></v-autocomplete></v-col></v-row><div class="grey lighten-4 pa-3 mb-3" style="border: 1px solid #B0BEC5; border-radius: 4px;"><v-row dense><v-col cols="12"><v-text-field v-model="editedHistoryItem.itemName" label="T?n H?ng" outlined dense></v-text-field></v-col><v-col cols="3"><v-text-field v-model.number="editedHistoryItem.qty" label="SL" type="number" outlined dense></v-text-field></v-col><v-col cols="3"><v-text-field v-model="editedHistoryItem.unit" label="?VT" outlined dense></v-text-field></v-col><v-col cols="3"><v-text-field v-model.number="editedHistoryItem.rate" label="HS" type="number" outlined dense></v-text-field></v-col><v-col cols="3"><v-select v-model="editedHistoryItem.rateState" :items="[{text:'G?c',value:0},{text:'Chia',value:2}]" label="Ch? ??" outlined dense></v-select></v-col></v-row></div></v-form></v-card-text><v-card-actions class="grey lighten-4 pa-4 justify-space-between"><v-btn color="red darken-1" text @click="requestDeleteHistory">X?a</v-btn><div><v-btn text class="mr-2" @click="dialogEditHistory=false">H?y</v-btn><v-btn color="blue darken-3" dark depressed @click="saveFullEdit">L?u</v-btn></div></v-card-actions></v-card></v-dialog>
<v-dialog v-model="dialogWidthConfig" max-width="500px"><v-card><v-card-title class="blue-grey darken-3 white--text subtitle-1 font-weight-bold"><v-icon left small dark>mdi-ruler</v-icon> C?U H?NH ?? R?NG C?T</v-card-title><v-card-text class="pt-4" style="max-height: 60vh; overflow-y: auto;"><v-simple-table dense><template v-slot:default><thead><tr><th class="text-left">T?n C?t</th><th class="text-right" width="120px">?? r?ng (px)</th></tr></thead><tbody><tr v-for="(header, index) in allHistoryHeaders" :key="index"><td class="font-weight-bold grey--text text--darken-2">{{ header.text }}</td><td><v-text-field v-model="header.width" type="number" dense hide-details outlined class="my-1 right-input" style="font-size: 13px;" @input="saveHeadersToLocal"></v-text-field></td></tr></tbody></template></v-simple-table></v-card-text><v-card-actions class="grey lighten-4 pa-3"><v-btn text color="red darken-1" small @click="resetColumnWidths"><v-icon left small>mdi-restore</v-icon> M?c ??nh</v-btn><v-spacer></v-spacer><v-btn color="blue darken-2" dark depressed @click="dialogWidthConfig = false">??ng</v-btn></v-card-actions></v-card></v-dialog>
<v-dialog v-model="dialogConfirm.show" max-width="450"><v-card><v-card-title class="headline grey lighten-3">{{dialogConfirm.title}}</v-card-title><v-card-text class="pt-5 title">{{dialogConfirm.text}}</v-card-text><v-card-actions><v-spacer></v-spacer><v-btn text @click="dialogConfirm.show=false">H?y</v-btn><v-btn color="blue darken-2" dark @click="onConfirmAction">??ng ?</v-btn></v-card-actions></v-card></v-dialog>

<v-dialog v-model="dialogImportSales.show" max-width="950px"><v-card><v-card-title class="blue darken-3 white--text font-weight-bold"><v-icon left dark>mdi-database-import</v-icon> IMPORT DOANH THU (AUDIT)</v-card-title><v-card-text class="pt-4"><v-row dense class="mb-3 mx-0" style="background: #E3F2FD; border: 1px solid #90CAF9; padding: 10px;"><v-col cols="12" class="pb-0"><div class="caption blue--text text--darken-3 font-weight-bold">B??C 1: X?C ??NH KHUNG TH?I GIAN</div></v-col><v-col cols="6"><v-text-field v-model="auditFromDate" type="date" label="T? ng?y" outlined dense class="white"></v-text-field></v-col><v-col cols="6"><v-text-field v-model="auditToDate" type="date" label="??n ng?y" outlined dense class="white"></v-text-field></v-col></v-row><div class="d-flex"><div style="width: 35%; padding-right: 10px;"><div class="subtitle-2 mb-1 font-weight-bold">B??C 2: Ch?n File & Ph?n T?ch</div><v-file-input v-model="excelFile" accept=".xlsx, .xls" label="Ch?n file Excel B?n H?ng (POS)" outlined dense prepend-icon="mdi-microsoft-excel" color="green darken-3" class="font-weight-bold mb-2" show-size></v-file-input><v-btn color="teal darken-3" dark block depressed class="font-weight-bold" @click="analyzeAuditFile" :loading="loading" :disabled="loading"><v-icon left>mdi-google-analytics</v-icon> PH?N T?CH NGAY</v-btn><div v-if="excelFile" class="caption green--text font-italic mb-2"><v-icon small color="green">mdi-check</v-icon> ?? ch?n: {{ excelFile.name }}</div></div><div style="width: 65%; padding-left: 10px; border-left: 1px solid #ddd; height: 350px; overflow-y: auto;"><div v-if="newProducts.length &gt; 0" class="mb-3"><v-alert type="warning" dense>Ph?t hi?n {{ newProducts.length }} m? m?i!</v-alert></div><div v-if="validSales.length &gt; 0"><div class="subtitle-2 green--text text--darken-3 mb-1">H?p l?: {{ validSales.length }} d?ng</div><v-simple-table dense fixed-header height="300px" style="border: 1px solid #C8E6C9"><thead><tr><th>M?</th><th>T?n</th><th class="text-right">T?ng</th><th class="text-right deep-orange--text">Deli</th><th class="text-right blue--text">Dine</th><th class="text-right teal--text">Take</th></tr></thead><tbody><tr v-for="s in validSales" :key="s.code&#43;s.store" :class="{'red lighten-5': s.isNew}"><td :class="s.isNew ? 'red--text font-weight-black' : 'blue--text font-weight-bold'">{{ s.code }} <v-icon v-if="s.isNew" x-small color="red">mdi-alert-circle</v-icon></td><td class="text-truncate" style="max-width:150px">{{ s.name }}</td><td class="text-right font-weight-black">{{ s.qty }}</td><td class="text-right deep-orange--text">{{ s.qtyDeli }}</td><td class="text-right blue--text">{{ s.qtyDine }}</td><td class="text-right teal--text">{{ s.qtyTake }}</td></tr></tbody></v-simple-table></div></div></div></v-card-text><v-card-actions class="grey lighten-3 pa-3"><v-spacer></v-spacer><v-btn text @click="dialogImportSales.show=false">??ng</v-btn><v-btn :disabled="validSales.length===0 || newProducts.length&gt;0" color="green darken-3" dark depressed @click="saveSalesToSystem">L?u Audit</v-btn></v-card-actions></v-card></v-dialog>
<v-dialog v-model="dialogQuickAdd.show" max-width="900px" persistent><v-card><v-card-title class="deep-orange darken-3 white--text title font-weight-bold"><v-icon left dark>mdi-new-box</v-icon> PH?T HI?N {{ newProducts.length }} M? M?I</v-card-title><v-card-text class="pt-4"><div class="subtitle-2 grey--text text--darken-3 mb-2">H? th?ng ph?t hi?n c?c m? ch?a c? trong danh m?c. X?c nh?n l?u ?? ti?p t?c?</div><v-simple-table dense fixed-header height="300px" style="border: 1px solid #FFCCBC;"><template v-slot:default><thead><tr class="deep-orange lighten-5"><th class="text-left">M? M?n</th><th class="text-left">T?n M?n</th><th class="text-left">Category</th><th class="text-left">Class</th><th class="text-left">B? Ph?n</th></tr></thead><tbody><tr v-for="(p, i) in newProducts" :key="i"><td class="font-weight-bold blue--text">{{ p.code }}</td><td class="font-weight-bold">{{ p.name }}</td><td>{{ p.category }}</td><td>{{ p.class }}</td><td><v-chip x-small label color="blue lighten-5" class="blue--text text--darken-3 font-weight-bold">{{ p.team }}</v-chip></td></tr></tbody></template></v-simple-table></v-card-text><v-card-actions class="grey lighten-4 pa-3"><v-spacer></v-spacer><v-btn text color="grey darken-2" @click="dialogQuickAdd.show = false">B? qua</v-btn><v-btn color="deep-orange darken-3" dark depressed class="font-weight-bold" @click="executeQuickAdd" :loading="loading"><v-icon left>mdi-content-save-plus</v-icon> L?U & IMPORT</v-btn></v-card-actions></v-card></v-dialog>
<v-dialog v-model="dialogReplace.show" max-width="500px"><v-card><v-card-title class="deep-orange darken-3 white--text title font-weight-bold"><v-icon left dark>mdi-swap-horizontal-bold</v-icon> THAY TH? NVL</v-card-title><v-card-text class="pt-6"><v-autocomplete v-model="dialogReplace.oldCode" :items="masterData" label="M? C?" item-text="fullName" item-value="code" outlined dense :filter="customFilterAutocomplete"></v-autocomplete><div class="d-flex justify-center my-n2"><v-icon large color="deep-orange">mdi-arrow-down-bold</v-icon></div><v-autocomplete v-model="dialogReplace.newCode" :items="masterData" label="M? M?i" item-text="fullName" item-value="code" outlined dense :filter="customFilterAutocomplete" class="mt-2"></v-autocomplete></v-card-text><v-card-actions class="grey lighten-4 pa-3"><v-spacer></v-spacer><v-btn text @click="dialogReplace.show=false">H?y</v-btn><v-btn color="deep-orange darken-3" dark depressed @click="executeBulkReplace">Th?c Hi?n</v-btn></v-card-actions></v-card></v-dialog>

<div>
  <v-overlay :value="loading" z-index="9999" class="text-center"><v-progress-circular indeterminate size="64" color="white" class="mb-2"></v-progress-circular><div class="white--text font-weight-bold headline">{{ loadingText || '?ang x? l?...' }}</div></v-overlay><v-snackbar v-model="snackbar" :color="snackColor" timeout="4000" top right><span class="font-weight-bold">{{ snackText }}</span></v-snackbar><v-dialog v-model="dialogConfigCols" max-width="450px" scrollable><v-card><v-card-title class="grey lighten-4 py-3 subtitle-1 font-weight-bold elevation-1" style="z-index:2"><v-icon left color="blue-grey">mdi-table-cog</v-icon> T?Y CH?NH C?T & S?P X?P</v-card-title><v-card-text class="pa-0" style="height: 500px; overflow-y: auto;"><div v-for="(header, index) in activeHeadersList" :key="header.value" draggable="true" @dragstart="dragStart(index, $event)" @dragover.prevent @drop="drop(index)" class="pa-2 d-flex align-center hover-item" style="cursor: move; border-bottom: 1px solid #eee; transition: all 0.2s"><v-icon color="grey darken-1" class="mr-3" style="cursor: move">mdi-drag-horizontal</v-icon><v-checkbox v-model="header.show" :label="header.text" hide-details dense class="mt-0 pt-0 font-weight-bold black--text" style="flex:1"></v-checkbox><v-chip x-small v-if="header.show" color="green lighten-5" class="green--text font-weight-bold">Hi?n th?</v-chip></div></v-card-text><v-card-actions class="grey lighten-4 pa-3"><v-btn text color="red darken-1" @click="localStorage.clear(); location.reload()">Reset M?c ??nh</v-btn><v-spacer></v-spacer><v-btn color="blue darken-3" dark depressed width="100" @click="dialogConfigCols=false">??ng</v-btn></v-card-actions></v-card></v-dialog>
  
<v-dialog v-model="dialogExportExcel" max-width="600px" persistent>
    <v-card>
        <v-card-title class="green darken-3 white--text font-weight-bold d-flex align-center">
            <v-icon left dark size="28">mdi-microsoft-excel</v-icon> 
            <span style="font-size: 18px;">XU?T FILE EXCEL SAP</span>
        </v-card-title>
        
        <v-card-text class="pt-6 pb-2">
            
            
            <div class="subtitle-2 mb-3 font-weight-black grey--text text--darken-3" style="font-size: 14px;">? KHO?NG TH?I GIAN</div>
            <v-radio-group v-model="exportConfig.dateMode" dense hide-details class="mt-0 mb-4">
                <v-radio label="Th?ng hi?n t?i" value="MONTH" class="mb-2"></v-radio>
                <v-radio label="Tu?n hi?n t?i" value="WEEK" class="mb-2" disabled>
                    <template v-slot:label>
                        <span class="grey--text">Tu?n hi?n t?i <small>(S?p c?)</small></span>
                    </template>
                </v-radio>
                <v-radio label="Ng?y hi?n t?i" value="TODAY" class="mb-2" disabled>
                    <template v-slot:label>
                        <span class="grey--text">Ng?y hi?n t?i <small>(S?p c?)</small></span>
                    </template>
                </v-radio>
                <v-radio label="T?y ch?nh" value="CUSTOM" disabled>
                    <template v-slot:label>
                        <span class="grey--text">T?y ch?nh <small>(S?p c?)</small></span>
                    </template>
                </v-radio>
            </v-radio-group>
            
            <v-divider class="my-4"></v-divider>
            
            
            <div class="subtitle-2 mb-3 font-weight-black grey--text text--darken-3" style="font-size: 14px;">?? ??N V? T?NH</div>
            <v-radio-group v-model="exportConfig.unitMode" dense hide-details class="mt-0 mb-4">
                <v-radio label="?VT G?c (Gr, ml...)" value="ORIGINAL" class="mb-2"></v-radio>
                <v-radio label="?VT Quy ??i (Kg, L?t...)" value="CONVERTED"></v-radio>
            </v-radio-group>
            
            <v-divider class="my-4"></v-divider>
            
            
            <div class="subtitle-2 mb-3 font-weight-black grey--text text--darken-3" style="font-size: 14px;">?? LO?I H?NG C?N XU?T</div>
            <v-row dense>
                <v-col cols="6">
                    <v-checkbox v-model="exportConfig.itemTypes" value="NVL" label="? NVL" dense hide-details class="mt-0 mb-2"></v-checkbox>
                    <v-checkbox v-model="exportConfig.itemTypes" value="SEMI" label="? SEMI" dense hide-details class="mt-0 mb-2"></v-checkbox>
                    <v-checkbox v-model="exportConfig.itemTypes" value="PROD" label="? PRODUCT" dense hide-details class="mt-0"></v-checkbox>
                </v-col>
                <v-col cols="6">
                    <v-checkbox v-model="exportConfig.explodeBOM" label="Bung BOM SEMI/PROD" dense hide-details class="mt-0" color="deep-orange"></v-checkbox>
                    <div class="caption grey--text mt-1" style="font-size: 11px; line-height: 1.3;">
                        (T?ch SEMI/PROD th?nh NVL g?c ?? import SAP)
                    </div>
                </v-col>
            </v-row>
            
            <v-alert type="info" dense text class="mt-4" style="font-size: 13px;">
                ? File s? bao g?m <b>{{ spoilageHistory ? spoilageHistory.filter(i => exportConfig.itemTypes.includes(i.type)).length : 0 }}</b> d?ng d? li?u
            </v-alert>
            
        </v-card-text>
        
        <v-card-actions class="grey lighten-4 pa-4">
            <v-spacer></v-spacer>
            <v-btn text @click="dialogExportExcel = false" class="font-weight-bold">H?Y</v-btn>
            <v-btn 
                color="green darken-3" 
                dark 
                depressed 
                @click="confirmExportExcel" 
                class="font-weight-bold px-6"
                :disabled="exportConfig.itemTypes.length === 0"
            >
                <v-icon left>mdi-download</v-icon> XU?T EXCEL
            </v-btn>
        </v-card-actions>
    </v-card>
</v-dialog>
</div>
<v-dialog v-model="dialogKaizen" max-width="600px"><v-card><v-card-title class="grey darken-4 white--text font-weight-bold"><v-icon left color="yellow accent-4">mdi-lightbulb-on</v-icon> KAIZEN BRAIN (N?P TRI TH?C)</v-card-title><v-card-text class="pt-4"><div class="caption grey--text mb-1">D?n quy t?c/logic m?i t? AI v?o ??y ?? h? th?ng t? h?c:</div><textarea v-model="kaizenInput" placeholder="Paste rule here..." class="native-textarea" style="min-height:200px;font-family:'Consolas',monospace;background:#263238;color:#81D4FA"></textarea></v-card-text><v-card-actions class="grey lighten-3 pa-3"><v-btn text color="red darken-3" class="mr-2 font-weight-bold" @click="executeBrainReset"><v-icon left small>mdi-alert</v-icon> GHI ?? (RESET)</v-btn><v-spacer></v-spacer><v-btn text @click="dialogKaizen=false">??ng</v-btn><v-btn color="black" dark depressed @click="executeKaizenUpdate"><v-icon left>mdi-send</v-icon> N?P (APPEND)</v-btn></v-card-actions></v-card></v-dialog>